---
import { rewriteWpUrl } from "../lib/wpUrl";
import Layout from "../layouts/Layout.astro";
import { wpQuery } from "../lib/wp";
import ARTICLES_QUERY from "../queries/articles";

const data = await wpQuery<{ posts: { nodes: any[] } }>(ARTICLES_QUERY, {});
const posts = data?.posts?.nodes ?? [];

function pickImageUrl(node?: any): string | undefined {   
  if (!node) return undefined;
  const medium = node?.mediaDetails?.sizes?.find?.((s: any) => s?.name === "medium");
  return medium?.sourceUrl || node?.sourceUrl;
}
---

<Layout showNavLinks={false}>
  <section class="mx-auto max-w-6xl px-6 py-10 sm:py-14">
    <div class="mb-6 flex items-center justify-between">
      <h1 class="text-3xl font-bold">บทความ</h1>
      <a href="/" class="text-sky-600 hover:underline">กลับหน้าแรก</a>
    </div>

    <div class="grid gap-6 sm:grid-cols-2 lg:grid-cols-3">
      {posts.map((post) => {
        const img = rewriteWpUrl(pickImageUrl(post?.featuredImage?.node));
        const href = `/articles/${post.slug}`;
        return (
          <article class="overflow-hidden rounded-xl border bg-white shadow-sm">
            <a href={href} aria-label={post.title}>
              {img && (
                <img
                  src={img}
                  alt={post.title}
                  class="aspect-[16/9] w-full object-cover"
                  loading="lazy"
                />
              )}
            </a>
            <div class="p-4">
              <a href={href} class="text-lg font-semibold line-clamp-2 hover:underline">
                {post.title}
              </a>
              {post.excerpt && (
                <p class="mt-1 text-sm text-slate-600 line-clamp-2" set:html={post.excerpt} />
              )}
              <a
                href={href}
                class="mt-3 inline-block rounded-md border px-3 py-1.5 text-sm hover:bg-slate-50"
              >
                อ่านต่อ
              </a>
            </div>
          </article>
        );
      })}
    </div>
  </section>
</Layout>
