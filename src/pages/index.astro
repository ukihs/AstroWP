---
import Layout from "../layouts/Layout.astro";
import { wpQuery } from "../lib/wp";
import HOME_QUERY from "../queries/home";
// ‚úÖ import ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô rewrite URL
import { rewriteWpUrl } from "../lib/wpUrl";

const data = await wpQuery<{ page: any }>(HOME_QUERY, {});
const page = data?.page ?? {};
const hero = page?.hero ?? {};
const process = page?.process ?? {};
const about = page?.about ?? {};
const contact = page?.contact ?? {};

function pickBestImageUrl(node?: any): string | undefined {
  if (!node) return undefined;
  const sizes: Array<any> = node?.mediaDetails?.sizes ?? [];
  const want = ["2048x2048", "1536x1536", "large", "medium_large", "medium"];
  for (const key of want) {
    const s = sizes.find((x: any) => x?.name === key);
    if (s?.sourceUrl) return s.sourceUrl;
  }
  return node?.sourceUrl;
}

// HERO
const heroImg = rewriteWpUrl(pickBestImageUrl(hero?.heroImage?.node));
const heroAlt = hero?.heroImage?.node?.altText || "hero";

// PRODUCT / ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á
const productImgUrl = rewriteWpUrl(pickBestImageUrl(process?.product1Img?.node));
const product =
  process?.product1Name || process?.product1Desc || productImgUrl
    ? {
        name: process?.product1Name,
        desc: process?.product1Desc,
        img: productImgUrl as string | undefined,
        price: process?.product1Price,
        link: process?.product1Link,
        alt:
          process?.product1Img?.node?.altText ||
          process?.product1Name ||
          "product",
      }
    : null;

// ABOUT (YouTube / ‡∏£‡∏π‡∏õ)
function toYouTubeEmbed(url?: string): string | undefined {
  if (!url) return undefined;
  try {
    const u = new URL(url);
    const host = u.hostname.replace(/^www\./, "");
    let id: string | null = null;
    if (host.includes("youtube.com")) {
      if (u.pathname === "/watch") id = u.searchParams.get("v");
      else if (u.pathname.startsWith("/embed/"))
        id = u.pathname.split("/embed/")[1];
      else if (u.pathname.startsWith("/shorts/"))
        id = u.pathname.split("/shorts/")[1];
    }
    if (host === "youtu.be") id = u.pathname.slice(1);
    if (!id) return undefined;
    return `https://www.youtube.com/embed/${id}?rel=0`;
  } catch {
    return undefined;
  }
}
const aboutEmbed = toYouTubeEmbed(about?.aboutYoutubeUrl);
const aboutImg = rewriteWpUrl(pickBestImageUrl(about?.aboutImage?.node));
const aboutAlt = about?.aboutImage?.node?.altText || "about";

// CONTACT
const contactTitle = contact?.contactTitle || "‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡πÄ‡∏£‡∏≤";
const contactIntro = contact?.contactIntro || "";
const contactPhone = contact?.contactPhone || "";
const contactEmail = contact?.contactEmail || "";
---

<Layout>
  <!-- HERO -->
  <section class="relative mx-auto max-w-6xl px-6 py-16 sm:py-20">
    {heroImg && (
      <div class="relative w-full overflow-hidden rounded-xl shadow-lg">
        <img
          src={heroImg}
          alt={heroAlt}
          class="w-full h-[400px] sm:h-[500px] object-cover"
          loading="lazy"
        />
        <div class="absolute inset-0 flex flex-col items-center justify-center text-center px-6">
          <h1 class="text-4xl sm:text-5xl font-bold text-white drop-shadow-lg">
            {hero?.heroTitle || "‡πÉ‡∏™‡πà‡∏´‡∏±‡∏ß‡∏Ç‡πâ‡∏≠‡∏à‡∏≤‡∏Å WP"}
          </h1>
          <p class="mt-3 text-lg text-white drop-shadow-md">
            {hero?.heroSubtitle || "‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏¢‡∏à‡∏≤‡∏Å WP"}
          </p>
          {hero?.heroPrimaryUrl && hero?.heroPrimaryText && (
            <a
              href={hero.heroPrimaryUrl}
              class="mt-6 inline-block rounded-md bg-sky-500 px-6 py-3 text-white text-lg font-medium hover:bg-sky-600 transition"
            >
              {hero.heroPrimaryText}
            </a>
          )}
        </div>
      </div>
    )}
  </section>

  <!-- ‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° -->
  <section id="products" class="mx-auto max-w-6xl px-6 py-16 sm:py-24 border-t">
    <h2 class="mb-6 text-2xl font-semibold">‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</h2>
    {product ? (
      <article class="grid gap-6 md:grid-cols-2 items-start border rounded-xl p-5 bg-white shadow">
        {product.img && (
          <img
            src={product.img}
            alt={product.alt}
            class="rounded-md w-full object-cover"
            loading="lazy"
          />
        )}
        <div>
          <h3 class="text-xl font-semibold">{product.name ?? "‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"}</h3>
          {product.price && (
            <div class="text-sky-600 font-medium mt-1">{product.price}</div>
          )}
          <p class="text-slate-600 mt-2">
            {product.desc ?? "‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤"}
          </p>
          <div class="mt-4 flex flex-wrap gap-3">
            <a
              href="/articles"
              class="inline-block rounded-md border border-sky-600 px-4 py-2 text-sky-700 hover:bg-sky-50"
            >
              ‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏° ‚Üí
            </a>
            {product.link && (
              <a
                href={product.link}
                target="_blank"
                rel="noopener"
                class="inline-block rounded-md bg-sky-600 px-4 py-2 text-white hover:bg-sky-700"
              >
                ‡∏î‡∏π‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‚Üí
              </a>
            )}
          </div>
        </div>
      </article>
    ) : (
      <p class="text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ö‡∏ó‡∏Ñ‡∏ß‡∏≤‡∏°</p>
    )}
  </section>

  <!-- ABOUT -->
  <section id="about" class="mx-auto max-w-6xl px-6 py-16 sm:py-24 border-t">
    <div class="grid gap-8 md:grid-cols-2 md:items-start">
      <div>
        <h2 class="text-2xl font-semibold">
          {about?.aboutTitle || "‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÄ‡∏£‡∏≤"}
        </h2>

        <div class="prose max-w-none mt-3">
          {about?.aboutBody
            ? <div set:html={about.aboutBody} />
            : <p class="text-slate-600">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÉ‡∏ô WordPress ‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏ü‡∏¥‡∏•‡∏î‡πå <code>aboutBody</code></p>}
        </div>
      </div>

      <div class="w-full">
        {aboutEmbed ? (
          <div class="relative w-full pt-[56.25%] overflow-hidden rounded-xl shadow">
            <iframe
              src={aboutEmbed}
              title="About video"
              class="absolute left-0 top-0 h-full w-full"
              allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share"
              allowfullscreen
              loading="lazy"
            />
          </div>
        ) : (
          <div class="rounded-xl border p-6 text-slate-500">
            ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏™‡πà‡∏•‡∏¥‡∏á‡∏Å‡πå YouTube ‡πÉ‡∏ô WP
          </div>
        )}
      </div>
    </div>
  </section>


  <!-- CONTACT -->
  <section id="contact" class="mx-auto max-w-6xl px-6 py-16 sm:py-24 border-t">
    <h2 class="text-2xl font-semibold mb-4">{contactTitle}</h2>
    {contactIntro && <p class="mb-4 text-slate-600">{contactIntro}</p>}
    <ul class="space-y-3">
      {contactPhone && (
        <li>
          <strong>üìû ‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå:</strong>{" "}
          <a href={`tel:${contactPhone}`} class="text-sky-600 hover:underline">
            {contactPhone}
          </a>
        </li>
      )}
      {contactEmail && (
        <li>
          <strong>‚úâÔ∏è ‡∏≠‡∏µ‡πÄ‡∏°‡∏•:</strong>{" "}
          <a
            href={`mailto:${contactEmail}`}
            class="text-sky-600 hover:underline"
          >
            {contactEmail}
          </a>
        </li>
      )}
    </ul>
  </section>
</Layout>
