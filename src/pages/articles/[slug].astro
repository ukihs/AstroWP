---
/** SSG: สร้างหน้าเดี่ยวจากทุก slug ที่ดึงมาจาก WP */

import Layout from "../../layouts/Layout.astro";
import { wpQuery } from "../../lib/wp";
import ARTICLE_BY_SLUG from "../../queries/articleBySlug";
import POST_SLUGS from "../../queries/postSlugs";

/* ---------- SSG paths ---------- */
export async function getStaticPaths() {
  // ดึง slug มา “พอประมาณ” (เปลี่ยน first ได้)
  const data = await wpQuery<{ posts: { nodes: Array<{ slug: string }> } }>(
    POST_SLUGS,
    { first: 200 }
  );
  const slugs = data?.posts?.nodes ?? [];
  return slugs.map(({ slug }) => ({ params: { slug } }));
}

/* ---------- helpers เฉพาะหน้านี้ ---------- */
function rewriteWpUrl(url?: string | null) {
  if (!url) return url ?? "";
  const base = new URL(import.meta.env.PUBLIC_WP_GRAPHQL!).origin;
  return url.replace(/^https?:\/\/[^/]+/i, base);
}

function rewriteHtmlImgSrc(html?: string | null) {
  if (!html) return html ?? "";
  const base = new URL(import.meta.env.PUBLIC_WP_GRAPHQL!).origin;

  let out = html.replace(
    /(src=)(["'])(https?:\/\/[^\/"']+)([^"']*)(\2)/gi,
    (_m, p1, q, _h, rest, q2) => `${p1}${q}${base}${rest}${q2}`
  );
  out = out.replace(
    /(data-src=)(["'])(https?:\/\/[^\/"']+)([^"']*)(\2)/gi,
    (_m, p1, q, _h, rest, q2) => `${p1}${q}${base}${rest}${q2}`
  );
  // รองรับ srcset ด้วย
  out = out.replace(
    /(srcset=)(["'])([^"']+)(\2)/gi,
    (_m, p1, q, val, q2) =>
      `${p1}${q}${val.replace(/https?:\/\/[^,\s"]+/gi, (u) =>
        u.replace(/^https?:\/\/[^/]+/i, base)
      )}${q2}`
  );
  return out;
}

function pickImageUrl(node?: any): string | undefined {
  if (!node) return undefined;
  const sizes = node?.mediaDetails?.sizes ?? [];
  const prefer = ["large", "medium_large", "medium", "1536x1536", "2048x2048"];
  for (const n of prefer) {
    const s = sizes.find((x: any) => x?.name === n);
    if (s?.sourceUrl) return s.sourceUrl;
  }
  return node?.sourceUrl;
}

/* ---------- fetch data per-page ---------- */
const { slug } = Astro.params;
const res = await wpQuery<{ post: any }>(ARTICLE_BY_SLUG, { slug });
const post = res?.post;
if (!post) {
  throw new Error(`ไม่พบบทความ slug="${slug}"`);
}

const hero = rewriteWpUrl(pickImageUrl(post?.featuredImage?.node));
const contentHtml = rewriteHtmlImgSrc(post?.content ?? post?.excerpt ?? "");
---

<Layout showNavLinks={false}>
  <article class="mx-auto max-w-3xl px-6 py-10 sm:py-14">
    <div class="mb-6 flex items-center justify-between">
      <h1 class="text-3xl font-bold leading-tight">{post.title}</h1>
      <a href="/articles" class="text-sky-600 hover:underline">กลับหน้าบทความ</a>
    </div>

    {hero && (
      <img
        src={hero}
        alt={post.title}
        class="mb-6 w-full rounded-xl border object-cover"
        loading="lazy"
      />
    )}

    <article class="prose max-w-none" set:html={contentHtml} />
  </article>
</Layout>
